{"version":3,"sources":["file:///Users/wangzhaoye/block-practice/block/assets/script/Mgr/WeaponManager.ts"],"names":["_decorator","Component","game","instantiate","Intersection2D","Layout","Node","Prefab","UITransform","v2","v3","GridData","CoinObj","WeaponData","Constants","WeaponItem","WeaponBgItem","oops","BlockUtil","EventConstant","ccclass","property","WeaponManager","init","instance","initWeaponListPos","initWeaponList","initRemoveWeaponList","size","getGridMapSize","weaponList","setPosition","width","height","preWeaponList","itemData","getGridItemMapData","forEach","weaponObj","key","gridObjArr","data","weaponCfg","getWeaponCfgById","wid","res","Type","path","weaponPath","pos","getItemPosByTiledObj","load","err","content","weaponItem","parent","getComponent","removeWeaponList","removeAllChildren","weaponIdData","getWeaponPool","placeId","getPlaceGridId","randIndex","Math","floor","random","length","splice","i","getUuid","itemType","weaponBgPath","updateRemoveLayOut","bagCfg","row_col","max_gridLen","split","row","Number","col","element","j","push","gridData","getGridMapData","n","m","value","getPlaceGridIdByWeigh","onRebuildWeaponPos","items","children","index","setBuildWeaponPos","showFlyGoldAnim","coinObj","wpos","convertToWorldSpaceAR","num","getRandomInt","emit","WEAPON_CHANGE_COIN","showHideRemoveList","status","active","len","diff","spaceX","spacingX","updateLayout","onAddRemoveWeaponList","item","onAddPreWeaponList","onWeaponPlace","gridIndexArr","curWeaponTildeIndex","includes","removeSynAction","isPlace","synKey","sanmeCount","placeIdArr","gridObj","getGridTiledByIndex","gridMapData","weaponKey","checkSameWeapoIdByKey","tempId","level","Level","group","weaponGroupNum","checkWeaponByLevel","node","removeFromParent","WEAPON_UPGRADE","weaponRemove","weaponPlace","SET_BATTLE_BTN_STATUS","WEAPON_ICON_STATUS_INIT","deletGridDataByWeaponId","WEAPON_REMOVE","startPos","getPosition","startR","isSyn","itemArr","getChildByName","endPos","convertToNodeSpaceAR","endR","circleCircle","x","y","itemCom","placeStatus","setNodeAngel","addGridDataByWeaponId","onEnable","on","ADD_REMOVE_WEAPON_LIST","ADD_PRE_WEAPON_LIST","WEAPON_PlACE","WEAPON_REMOVE_REFRESH","INIT_BUILD_WEAPON_POS","onDisable","off","clear"],"mappings":"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","sourcesContent":["import { _decorator, Component, game, instantiate, Intersection2D, Layout, Node, Prefab, UITransform, v2, v3 } from 'cc';\r\nimport { GridData, GridObj, WeaponObj } from '../Data/GridData';\r\nimport { CoinObj, WeaponData } from '../Data/WeaponData';\r\nimport { Constants } from '../../Constants';\r\nimport { WeaponItem } from '../Weapon/WeaponItem';\r\nimport { WeaponBgItem } from '../Weapon/WeaponBgItem';\r\nimport { oops } from '../../../../../script-oops/core/Oops';\r\nimport { BlockUtil } from '../../../../battle/util/Util';\r\nimport { EventConstant } from '../../../../constant/EventConstant';\r\nconst { ccclass, property } = _decorator;\r\n\r\n@ccclass('WeaponManager')\r\nexport class WeaponManager extends Component {\r\n    @property(Node)\r\n    private weaponList: Node = null!;\r\n    @property(Node)\r\n    private preWeaponList: Node = null!;\r\n    @property(Node)\r\n    private removeWeaponList: Node = null!;\r\n\r\n    public init() {\r\n        WeaponData.instance.init();\r\n        this.initWeaponListPos();\r\n        this.initWeaponList();\r\n        this.initRemoveWeaponList();\r\n    }\r\n\r\n    private initWeaponListPos() {\r\n        let size = GridData.instance.getGridMapSize();\r\n        this.weaponList.setPosition(-size.width / 2, size.height / 2);\r\n        this.preWeaponList.setPosition(-size.width / 2, size.height / 2);\r\n    }\r\n\r\n    private initWeaponList() {\r\n        let itemData = GridData.instance.getGridItemMapData();\r\n        itemData.forEach((weaponObj: WeaponObj, key: string) => {\r\n            let gridObjArr = weaponObj.data;\r\n            let weaponCfg = WeaponData.instance.getWeaponCfgById(weaponObj.wid);\r\n            let res = weaponCfg.Type;\r\n            let path = Constants.weaponPath;\r\n            let pos = GridData.instance.getItemPosByTiledObj(gridObjArr);\r\n\r\n            oops.res.load(path, Prefab, (err: Error | null, content: Prefab) => {\r\n                let weaponItem = instantiate(content);\r\n                weaponItem.parent = this.weaponList;\r\n                weaponItem.setPosition(pos);\r\n                weaponItem.getComponent(WeaponItem)!.init(weaponCfg, key, true);\r\n            });\r\n        })\r\n    }\r\n\r\n    /* 初始化卸下(掉落)的武器列表 */\r\n    private initRemoveWeaponList() {\r\n        //调试获取1级武器\r\n        this.removeWeaponList.removeAllChildren();\r\n        let weaponIdData: Array<number> = WeaponData.instance.getWeaponPool();\r\n        //生成格子\r\n        let placeId = this.getPlaceGridId();\r\n        if (placeId) {\r\n            let randIndex = Math.floor(Math.random() * weaponIdData.length);\r\n            weaponIdData.splice(randIndex, 1, placeId);\r\n        }\r\n        for (let i = 0; i < weaponIdData.length; i++) {\r\n            let weaponCfg = WeaponData.instance.getWeaponCfgById(weaponIdData[i]);\r\n            let key = BlockUtil.getUuid(10);    //TODO:流水ID\r\n            let path: string = '1';\r\n            if (weaponCfg.itemType == \"1\") {\r\n                path = Constants.weaponPath;\r\n            }\r\n            else if (weaponCfg.itemType == \"2\") {   // TODO: 少一个配件\r\n\r\n            }\r\n            else if (weaponCfg.itemType == \"3\") {\r\n                path = Constants.weaponBgPath;\r\n            }\r\n\r\n            oops.res.load(path, Prefab, (err: Error | null, content: Prefab) => {\r\n                let weaponItem = instantiate(content);\r\n                weaponItem.parent = this.removeWeaponList;\r\n\r\n                if (weaponCfg.itemType == \"1\") {\r\n                    weaponItem.getComponent(WeaponItem)!.init(weaponCfg, key, false);\r\n                }\r\n                else if (weaponCfg.itemType == \"2\") {   // TODO: 少一个配件\r\n\r\n                }\r\n                else if (weaponCfg.itemType == \"3\") {\r\n                    //格子\r\n                    weaponItem.getComponent(WeaponBgItem)!.init(weaponCfg, key, false);\r\n                }\r\n                this.updateRemoveLayOut();\r\n            });\r\n        }\r\n    }\r\n\r\n    /* 获取可以放置的搁置id \r\n      0：未占位 1：占位\r\n    */\r\n    private getPlaceGridId() {\r\n        let bagCfg = GridData.instance.bagCfg;\r\n        let row_col = bagCfg.max_gridLen.split('_');\r\n        let row = Number(row_col[0]);\r\n        let col = Number(row_col[1]);\r\n        let data: Array<Array<number>> = [];\r\n        let placeId = 0;\r\n        for (let i = 0; i < row; i++) {\r\n            let element = [];\r\n            for (let j = 0; j < col; j++) {\r\n                element.push(1);\r\n            }\r\n            data.push(element);\r\n        }\r\n        let gridData = GridData.instance.getGridMapData();\r\n        for (let n = 0; n < gridData.length; n++) {\r\n            const element = gridData[n];\r\n            for (let m = 0; m < element.length; m++) {\r\n                const value = element[m];\r\n                if (value) {\r\n                    data[n][m] = 0;\r\n                }\r\n            }\r\n        }\r\n        placeId = WeaponData.instance.getPlaceGridIdByWeigh(data);\r\n        return placeId;\r\n    }\r\n\r\n    /* 重组武器的位置 */\r\n    private onRebuildWeaponPos() {\r\n        let itemData = GridData.instance.getGridItemMapData();\r\n        itemData.forEach((weaponObj: WeaponObj, key: string) => {\r\n            let gridObjArr = weaponObj.data;\r\n            let pos = GridData.instance.getItemPosByTiledObj(gridObjArr);\r\n            let items = this.weaponList.children;\r\n            for (let index = 0; index < items.length; index++) {\r\n                const weaponItem = items[index];\r\n                weaponItem.getComponent(WeaponItem)!.setBuildWeaponPos(key, pos);\r\n            }\r\n        })\r\n    }\r\n\r\n\r\n    /* 转换飞的金币动画 */\r\n    private showFlyGoldAnim() {\r\n        if (this.removeWeaponList.children.length) {\r\n            let items = this.removeWeaponList.children;\r\n            for (let i = 0; i < items.length; i++) {\r\n                const element = items[i];\r\n                let coinObj = new CoinObj();\r\n                coinObj.wpos = element.getComponent(UITransform)!.convertToWorldSpaceAR(v3(0, 0, 0));\r\n                coinObj.num = BlockUtil.getRandomInt(5, 10);\r\n                game.emit(EventConstant.WEAPON_CHANGE_COIN, coinObj);\r\n            }\r\n        }\r\n    }\r\n\r\n    /* 隐藏显示卸载列表 */\r\n    private showHideRemoveList(status: boolean) {\r\n        this.removeWeaponList.active = status;\r\n    }\r\n\r\n    /* 根据内容设置排布 */\r\n    private updateRemoveLayOut() {\r\n        let len = this.removeWeaponList.children.length;\r\n        let diff = (len - 3) > 0 ? len - 3 : 0;\r\n        let spaceX = 0 - diff * 10;\r\n        this.removeWeaponList.getComponent(Layout)!.spacingX = spaceX;\r\n        this.removeWeaponList.getComponent(Layout)!.updateLayout(true);\r\n    }\r\n\r\n    /* 添加到卸下武器列表 */\r\n    private onAddRemoveWeaponList(item?: Node) {\r\n        item!.parent = this.removeWeaponList;\r\n        this.updateRemoveLayOut();\r\n    }\r\n\r\n    /* 添加到临时武器列表 */\r\n    private onAddPreWeaponList(item?: Node) {\r\n        item!.parent = this.preWeaponList;\r\n    }\r\n\r\n    /* 武器放置完成 */\r\n    private onWeaponPlace(weaponItem?: WeaponItem) {\r\n        let gridIndexArr = GridData.instance.curWeaponTildeIndex;\r\n        //1.放置 2.替换 3.卸下\r\n        if (gridIndexArr.includes(-1)) {\r\n            //卸下(外合成)\r\n            this.removeSynAction(weaponItem!);\r\n        }\r\n        else {\r\n            let isPlace = false; //是否替换和合成\r\n            let synKey = '';//被合成的装备key\r\n            let sanmeCount = 0;//相同wid 数量\r\n            let placeIdArr = []; //替换的武器唯一id(可能多个)\r\n            let gridObjArr: Array<GridObj> = [];\r\n            for (let i = 0; i < gridIndexArr.length; i++) {\r\n                const index = gridIndexArr[i];\r\n                let gridObj = GridData.instance.getGridTiledByIndex(index);\r\n                let gridMapData = GridData.instance.getGridMapData();\r\n                gridObjArr.push(gridObj);\r\n                if (gridMapData[gridObj.row][gridObj.col]) {\r\n                    //占用(替换)\r\n                    if (!isPlace) {\r\n                        isPlace = true;\r\n                    }\r\n                    let weaponKey = gridMapData[gridObj.row][gridObj.col];\r\n                    placeIdArr.push(weaponKey);\r\n                    //检测武器id、等级是否相同\r\n                    if (GridData.instance.checkSameWeapoIdByKey(weaponKey, weaponItem!.weaponCfg.tempId)) {\r\n                        sanmeCount++;\r\n                        synKey = weaponKey;\r\n                    }\r\n                }\r\n            }\r\n            if (isPlace) {\r\n                //替换或合成(卸下 + 放置)\r\n                //是否有可以合成的下一级别\r\n                let level = weaponItem!.weaponCfg.Level;\r\n                let group = weaponItem!.weaponCfg.weaponGroupNum;\r\n                if (sanmeCount == gridIndexArr.length && WeaponData.instance.checkWeaponByLevel(level + 1, group)) {\r\n                    weaponItem!.node.removeFromParent();\r\n                    //合成(内合成)\r\n                    game.emit(EventConstant.WEAPON_UPGRADE, synKey, true);\r\n                }\r\n                else {\r\n                    //卸下\r\n                    this.weaponRemove(placeIdArr);\r\n                    //放置\r\n                    this.weaponPlace(weaponItem!, gridObjArr);\r\n                }\r\n\r\n            }\r\n            else {\r\n                //没占用直接放置\r\n                this.weaponPlace(weaponItem!, gridObjArr);\r\n            }\r\n        }\r\n        //设置战斗按钮状态\r\n        game.emit(EventConstant.SET_BATTLE_BTN_STATUS);\r\n        //初始状态\r\n        game.emit(EventConstant.WEAPON_ICON_STATUS_INIT);\r\n    }\r\n\r\n    /* 卸下 */\r\n    private weaponRemove(placeIdArr: Array<string>) {\r\n        for (let i = 0; i < placeIdArr.length; i++) {\r\n            const weaponKey = placeIdArr[i];\r\n            GridData.instance.deletGridDataByWeaponId(weaponKey);\r\n            game.emit(EventConstant.WEAPON_REMOVE, weaponKey);\r\n        }\r\n    }\r\n\r\n    /* 卸下合成 */\r\n    private removeSynAction(weaponItem: WeaponItem) {\r\n        let startPos = weaponItem.node.getPosition();\r\n        let startR = 100;\r\n        let isSyn: boolean = false;\r\n        let synKey = '';//被合成的装备key\r\n        //检测是否可以外合成\r\n        let itemArr = this.removeWeaponList.children;\r\n        for (let i = 0; i < itemArr.length; i++) {\r\n            const item = itemArr[i];\r\n            if (item.getComponent(WeaponItem)) {\r\n                //是否未武器  非格子\r\n                let wpos = item.getChildByName('icon')!.getComponent(UITransform)!.convertToWorldSpaceAR(v3(0, 0, 0));\r\n                let endPos = this.preWeaponList.getComponent(UITransform)!.convertToNodeSpaceAR(wpos);\r\n                let endR = 100;\r\n                if (Intersection2D.circleCircle(v2(startPos.x, startPos.y), startR, v2(endPos.x, endPos.y), endR)) {\r\n                    let itemCom = item.getComponent(WeaponItem)!;\r\n                    //是否可以合成 相同等级  有可以合成的下一级\r\n                    let level = weaponItem.weaponCfg.Level;\r\n                    let group = weaponItem.weaponCfg.weaponGroupNum;\r\n                    if (weaponItem.weaponCfg.tempId == itemCom.weaponCfg.tempId && WeaponData.instance.checkWeaponByLevel(level + 1, group)) {\r\n                        isSyn = true;\r\n                        synKey = itemCom.weaponKey;\r\n                    }\r\n                }\r\n            }\r\n        }\r\n        if (isSyn) {\r\n            weaponItem.node.removeFromParent();\r\n            //合成(外合成)\r\n            game.emit(EventConstant.WEAPON_UPGRADE, synKey, false);\r\n        }\r\n        else {\r\n            weaponItem.node.parent = this.removeWeaponList;\r\n            weaponItem.placeStatus = false;\r\n            weaponItem.setNodeAngel();\r\n            this.updateRemoveLayOut();\r\n        }\r\n    }\r\n\r\n    /* 放置 */\r\n    private weaponPlace(weaponItem: WeaponItem, gridObjArr: Array<GridObj>) {\r\n        weaponItem.node.parent = this.weaponList;\r\n        GridData.instance.addGridDataByWeaponId(gridObjArr, weaponItem.weaponCfg.tempId, weaponItem.weaponKey);\r\n        let pos = GridData.instance.getItemPosByTiledObj(gridObjArr);\r\n        weaponItem.node.setPosition(pos);\r\n        weaponItem.placeStatus = true;\r\n        weaponItem.setNodeAngel();\r\n    }\r\n\r\n    protected onEnable(): void {\r\n        game.on(EventConstant.ADD_REMOVE_WEAPON_LIST, this.onAddRemoveWeaponList, this);\r\n        game.on(EventConstant.ADD_PRE_WEAPON_LIST, this.onAddPreWeaponList, this);\r\n        game.on(EventConstant.WEAPON_PlACE, this.onWeaponPlace, this);\r\n        game.on(EventConstant.WEAPON_REMOVE_REFRESH, this.initRemoveWeaponList, this);\r\n        game.on(EventConstant.INIT_BUILD_WEAPON_POS, this.onRebuildWeaponPos, this);\r\n    }\r\n\r\n    protected onDisable(): void {\r\n        game.off(EventConstant.ADD_REMOVE_WEAPON_LIST, this.onAddRemoveWeaponList, this);\r\n        game.off(EventConstant.ADD_PRE_WEAPON_LIST, this.onAddPreWeaponList, this);\r\n        game.off(EventConstant.WEAPON_PlACE, this.onWeaponPlace, this);\r\n        game.off(EventConstant.WEAPON_REMOVE_REFRESH, this.initRemoveWeaponList, this);\r\n        game.off(EventConstant.INIT_BUILD_WEAPON_POS, this.onRebuildWeaponPos, this);\r\n\r\n    }\r\n\r\n    public clear() {\r\n        WeaponData.instance.clear();\r\n    }\r\n}\r\n\r\n\r\n"]}