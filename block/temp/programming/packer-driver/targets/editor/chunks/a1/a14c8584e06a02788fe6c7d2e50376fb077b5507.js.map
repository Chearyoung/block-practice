{"version":3,"sources":["file:///Users/jhh/Desktop/projects/block_project/block-practice/block/assets/script/Mgr/WeaponManager.ts"],"names":["_decorator","Component","game","instantiate","Intersection2D","Layout","Node","Prefab","UITransform","v2","v3","resources","GridData","WeaponData","Constants","WeaponItem","WeaponBgItem","BlockUtil","EventConstant","ccclass","property","WeaponManager","init","instance","initWeaponListPos","initWeaponList","initRemoveWeaponList","size","getGridMapSize","weaponList","setPosition","width","height","preWeaponList","itemData","getGridItemMapData","forEach","weaponObj","key","gridObjArr","data","weaponCfg","getWeaponCfgById","wid","res","Type","path","weaponPath","pos","getItemPosByTiledObj","load","err","content","weaponItem","parent","getComponent","removeWeaponList","removeAllChildren","weaponIdData","getWeaponPool","placeId","getPlaceGridId","randIndex","Math","floor","random","length","splice","i","getUuid","itemType","weaponBgPath","console","error","updateRemoveLayOut","emit","GAME_TAP_BTN","bagCfg","row_col","max_gridLen","split","row","Number","col","element","j","push","gridData","getGridMapData","n","m","value","getPlaceGridIdByWeigh","onRebuildWeaponPos","items","children","index","setBuildWeaponPos","len","diff","spaceX","spacingX","updateLayout","onAddRemoveWeaponList","item","onAddPreWeaponList","onWeaponPlace","gridIndexArr","curWeaponTildeIndex","includes","removeSynAction","isPlace","synKey","sanmeCount","placeIdArr","gridObj","getGridTiledByIndex","gridMapData","weaponKey","checkSameWeapoIdByKey","tempId","level","Level","group","weaponGroupNum","checkWeaponByLevel","node","removeFromParent","WEAPON_UPGRADE","weaponRemove","weaponPlace","SET_BATTLE_BTN_STATUS","WEAPON_ICON_STATUS_INIT","deletGridDataByWeaponId","WEAPON_REMOVE","startPos","getPosition","startR","isSyn","itemArr","wpos","getChildByName","convertToWorldSpaceAR","endPos","convertToNodeSpaceAR","endR","circleCircle","x","y","itemCom","placeStatus","setNodeAngel","addGridDataByWeaponId","onEnable","on","ADD_REMOVE_WEAPON_LIST","ADD_PRE_WEAPON_LIST","WEAPON_PlACE","WEAPON_REMOVE_REFRESH","INIT_BUILD_WEAPON_POS","onDisable","off","clear"],"mappings":"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","sourcesContent":["import { _decorator, Component, game, instantiate, Intersection2D, Layout, Node, Prefab, UITransform, v2, v3 , resources } from 'cc';\r\nimport { GridData, GridObj, WeaponObj } from '../Data/GridData';\r\nimport { CoinObj, WeaponData } from '../Data/WeaponData';\r\nimport { Constants } from '../Constants';\r\nimport { WeaponItem } from '../Weapon/WeaponItem';\r\nimport { WeaponBgItem } from '../Weapon/WeaponBgItem';\r\nimport { BlockUtil } from '../Util';\r\nimport { EventConstant } from '../EventConstant';\r\nconst { ccclass, property } = _decorator;\r\n\r\n@ccclass('WeaponManager')\r\nexport class WeaponManager extends Component {\r\n    @property(Node)\r\n    private weaponList: Node = null!;\r\n    @property(Node)\r\n    private preWeaponList: Node = null!;\r\n    @property(Node)\r\n    private removeWeaponList: Node = null!;\r\n\r\n    public init() {\r\n        WeaponData.instance.init();\r\n        this.initWeaponListPos();\r\n        this.initWeaponList();\r\n        this.initRemoveWeaponList();\r\n    }\r\n\r\n    private initWeaponListPos() {\r\n        let size = GridData.instance.getGridMapSize();\r\n        this.weaponList.setPosition(-size.width / 2, size.height / 2);\r\n        this.preWeaponList.setPosition(-size.width / 2, size.height / 2);\r\n    }\r\n\r\n    private initWeaponList() {\r\n        let itemData = GridData.instance.getGridItemMapData();\r\n        itemData.forEach((weaponObj: WeaponObj, key: string) => {\r\n            let gridObjArr = weaponObj.data;\r\n            let weaponCfg = WeaponData.instance.getWeaponCfgById(weaponObj.wid);\r\n            let res = weaponCfg.Type;\r\n            let path = Constants.weaponPath;\r\n            let pos = GridData.instance.getItemPosByTiledObj(gridObjArr);\r\n\r\n            resources.load(path, Prefab, (err: Error | null, content: Prefab) => {\r\n                let weaponItem = instantiate(content);\r\n                weaponItem.parent = this.weaponList;\r\n                weaponItem.setPosition(pos);\r\n                weaponItem.getComponent(WeaponItem)!.init(weaponCfg, key, true);\r\n            });\r\n        })\r\n    }\r\n\r\n    /* 初始化卸下(掉落)的武器列表 */\r\n    private initRemoveWeaponList() {\r\n        //调试获取1级武器\r\n        this.removeWeaponList.removeAllChildren();\r\n        let weaponIdData: Array<number> = WeaponData.instance.getWeaponPool();\r\n        //生成格子\r\n        let placeId = this.getPlaceGridId();\r\n        if (placeId) {\r\n            let randIndex = Math.floor(Math.random() * weaponIdData.length);\r\n            weaponIdData.splice(randIndex, 1, placeId);\r\n        }\r\n        for (let i = 0; i < weaponIdData.length; i++) {\r\n            let weaponCfg = WeaponData.instance.getWeaponCfgById(weaponIdData[i]);\r\n            let key = BlockUtil.getUuid(10);    //TODO:流水ID\r\n            let path: string = '1';\r\n            if (weaponCfg.itemType == \"1\") {\r\n                path = Constants.weaponPath;\r\n            }\r\n            else if (weaponCfg.itemType == \"2\") {   // TODO: 少一个配件\r\n\r\n            }\r\n            else if (weaponCfg.itemType == \"3\") {\r\n                path = Constants.weaponBgPath;\r\n            }\r\n\r\n            resources.load(path, Prefab, (err: Error | null, content: Prefab) => {\r\n                if (err) {\r\n                    console.error('Failed to load prefab:', err);\r\n                    return;\r\n                }\r\n            \r\n                let weaponItem = instantiate(content);\r\n                weaponItem.parent = this.removeWeaponList;\r\n            \r\n                if (weaponCfg.itemType == \"1\") {\r\n                    weaponItem.getComponent(WeaponItem)!.init(weaponCfg, key, false);\r\n                } else if (weaponCfg.itemType == \"2\") {\r\n                    // TODO: 处理 itemType 为 \"2\" 的情况\r\n                } else if (weaponCfg.itemType == \"3\") {\r\n                    weaponItem.getComponent(WeaponBgItem)!.init(weaponCfg, key, false);\r\n                }\r\n            \r\n                this.updateRemoveLayOut();\r\n            });\r\n            game.emit(EventConstant.GAME_TAP_BTN);\r\n        }\r\n    }\r\n\r\n    /* 获取可以放置的搁置id \r\n      0：未占位 1：占位\r\n    */\r\n    private getPlaceGridId() {\r\n        let bagCfg = GridData.instance.bagCfg;\r\n        let row_col = bagCfg.max_gridLen.split('_');\r\n        let row = Number(row_col[0]);\r\n        let col = Number(row_col[1]);\r\n        let data: Array<Array<number>> = [];\r\n        let placeId = 0;\r\n        for (let i = 0; i < row; i++) {\r\n            let element = [];\r\n            for (let j = 0; j < col; j++) {\r\n                element.push(1);\r\n            }\r\n            data.push(element);\r\n        }\r\n        let gridData = GridData.instance.getGridMapData();\r\n        for (let n = 0; n < gridData.length; n++) {\r\n            const element = gridData[n];\r\n            for (let m = 0; m < element.length; m++) {\r\n                const value = element[m];\r\n                if (value) {\r\n                    data[n][m] = 0;\r\n                }\r\n            }\r\n        }\r\n        placeId = WeaponData.instance.getPlaceGridIdByWeigh(data);\r\n        return placeId;\r\n    }\r\n\r\n    /* 重组武器的位置 */\r\n    private onRebuildWeaponPos() {\r\n        let itemData = GridData.instance.getGridItemMapData();\r\n        itemData.forEach((weaponObj: WeaponObj, key: string) => {\r\n            let gridObjArr = weaponObj.data;\r\n            let pos = GridData.instance.getItemPosByTiledObj(gridObjArr);\r\n            let items = this.weaponList.children;\r\n            for (let index = 0; index < items.length; index++) {\r\n                const weaponItem = items[index];\r\n                weaponItem.getComponent(WeaponItem)!.setBuildWeaponPos(key, pos);\r\n            }\r\n        })\r\n    }\r\n\r\n    /* 根据内容设置排布 */\r\n    private updateRemoveLayOut() {\r\n        let len = this.removeWeaponList.children.length;\r\n        let diff = (len - 3) > 0 ? len - 3 : 0;\r\n        let spaceX = 0 - diff * 10;\r\n        this.removeWeaponList.getComponent(Layout)!.spacingX = spaceX;\r\n        this.removeWeaponList.getComponent(Layout)!.updateLayout(true);\r\n    }\r\n\r\n    /* 添加到卸下武器列表 */\r\n    private onAddRemoveWeaponList(item?: Node) {\r\n        item!.parent = this.removeWeaponList;\r\n        this.updateRemoveLayOut();\r\n    }\r\n\r\n    /* 添加到临时武器列表 */\r\n    private onAddPreWeaponList(item?: Node) {\r\n        item!.parent = this.preWeaponList;\r\n    }\r\n\r\n    /* 武器放置完成 */\r\n    private onWeaponPlace(weaponItem?: WeaponItem) {\r\n        let gridIndexArr = GridData.instance.curWeaponTildeIndex;\r\n        //1.放置 2.替换 3.卸下\r\n        if (gridIndexArr.includes(-1)) {\r\n            //卸下(外合成)\r\n            this.removeSynAction(weaponItem!);\r\n        }\r\n        else {\r\n            let isPlace = false; //是否替换和合成\r\n            let synKey = '';//被合成的装备key\r\n            let sanmeCount = 0;//相同wid 数量\r\n            let placeIdArr = []; //替换的武器唯一id(可能多个)\r\n            let gridObjArr: Array<GridObj> = [];\r\n            for (let i = 0; i < gridIndexArr.length; i++) {\r\n                const index = gridIndexArr[i];\r\n                let gridObj = GridData.instance.getGridTiledByIndex(index);\r\n                let gridMapData = GridData.instance.getGridMapData();\r\n                gridObjArr.push(gridObj);\r\n                if (gridMapData[gridObj.row][gridObj.col]) {\r\n                    //占用(替换)\r\n                    if (!isPlace) {\r\n                        isPlace = true;\r\n                    }\r\n                    let weaponKey = gridMapData[gridObj.row][gridObj.col];\r\n                    placeIdArr.push(weaponKey);\r\n                    //检测武器id、等级是否相同\r\n                    if (GridData.instance.checkSameWeapoIdByKey(weaponKey, weaponItem!.weaponCfg.tempId)) {\r\n                        sanmeCount++;\r\n                        synKey = weaponKey;\r\n                    }\r\n                }\r\n            }\r\n            if (isPlace) {\r\n                //替换或合成(卸下 + 放置)\r\n                //是否有可以合成的下一级别\r\n                let level = weaponItem!.weaponCfg.Level;\r\n                let group = weaponItem!.weaponCfg.weaponGroupNum;\r\n                if (sanmeCount == gridIndexArr.length && WeaponData.instance.checkWeaponByLevel(level + 1, group)) {\r\n                    weaponItem!.node.removeFromParent();\r\n                    //合成(内合成)\r\n                    game.emit(EventConstant.WEAPON_UPGRADE, synKey, true);\r\n                }\r\n                else {\r\n                    //卸下\r\n                    this.weaponRemove(placeIdArr);\r\n                    //放置\r\n                    this.weaponPlace(weaponItem!, gridObjArr);\r\n                }\r\n\r\n            }\r\n            else {\r\n                //没占用直接放置\r\n                this.weaponPlace(weaponItem!, gridObjArr);\r\n            }\r\n        }\r\n        //设置战斗按钮状态\r\n        game.emit(EventConstant.SET_BATTLE_BTN_STATUS);\r\n        //初始状态\r\n        game.emit(EventConstant.WEAPON_ICON_STATUS_INIT);\r\n    }\r\n\r\n    /* 卸下 */\r\n    private weaponRemove(placeIdArr: Array<string>) {\r\n        for (let i = 0; i < placeIdArr.length; i++) {\r\n            const weaponKey = placeIdArr[i];\r\n            GridData.instance.deletGridDataByWeaponId(weaponKey);\r\n            game.emit(EventConstant.WEAPON_REMOVE, weaponKey);\r\n        }\r\n    }\r\n\r\n    /* 卸下合成 */\r\n    private removeSynAction(weaponItem: WeaponItem) {\r\n        let startPos = weaponItem.node.getPosition();\r\n        let startR = 100;\r\n        let isSyn: boolean = false;\r\n        let synKey = '';//被合成的装备key\r\n        //检测是否可以外合成\r\n        let itemArr = this.removeWeaponList.children;\r\n        for (let i = 0; i < itemArr.length; i++) {\r\n            const item = itemArr[i];\r\n            if (item.getComponent(WeaponItem)) {\r\n                //是否未武器  非格子\r\n                let wpos = item.getChildByName('icon')!.getComponent(UITransform)!.convertToWorldSpaceAR(v3(0, 0, 0));\r\n                let endPos = this.preWeaponList.getComponent(UITransform)!.convertToNodeSpaceAR(wpos);\r\n                let endR = 100;\r\n                if (Intersection2D.circleCircle(v2(startPos.x, startPos.y), startR, v2(endPos.x, endPos.y), endR)) {\r\n                    let itemCom = item.getComponent(WeaponItem)!;\r\n                    //是否可以合成 相同等级  有可以合成的下一级\r\n                    let level = weaponItem.weaponCfg.Level;\r\n                    let group = weaponItem.weaponCfg.weaponGroupNum;\r\n                    if (weaponItem.weaponCfg.tempId == itemCom.weaponCfg.tempId && WeaponData.instance.checkWeaponByLevel(level + 1, group)) {\r\n                        isSyn = true;\r\n                        synKey = itemCom.weaponKey;\r\n                    }\r\n                }\r\n            }\r\n        }\r\n        if (isSyn) {\r\n            weaponItem.node.removeFromParent();\r\n            //合成(外合成)\r\n            game.emit(EventConstant.WEAPON_UPGRADE, synKey, false);\r\n        }\r\n        else {\r\n            weaponItem.node.parent = this.removeWeaponList;\r\n            weaponItem.placeStatus = false;\r\n            weaponItem.setNodeAngel();\r\n            this.updateRemoveLayOut();\r\n        }\r\n    }\r\n\r\n    /* 放置 */\r\n    private weaponPlace(weaponItem: WeaponItem, gridObjArr: Array<GridObj>) {\r\n        weaponItem.node.parent = this.weaponList;\r\n        GridData.instance.addGridDataByWeaponId(gridObjArr, weaponItem.weaponCfg.tempId, weaponItem.weaponKey);\r\n        let pos = GridData.instance.getItemPosByTiledObj(gridObjArr);\r\n        weaponItem.node.setPosition(pos);\r\n        weaponItem.placeStatus = true;\r\n        weaponItem.setNodeAngel();\r\n    }\r\n\r\n    protected onEnable(): void {\r\n        game.on(EventConstant.ADD_REMOVE_WEAPON_LIST, this.onAddRemoveWeaponList, this);\r\n        game.on(EventConstant.ADD_PRE_WEAPON_LIST, this.onAddPreWeaponList, this);\r\n        game.on(EventConstant.WEAPON_PlACE, this.onWeaponPlace, this);\r\n        game.on(EventConstant.WEAPON_REMOVE_REFRESH, this.initRemoveWeaponList, this);\r\n        game.on(EventConstant.INIT_BUILD_WEAPON_POS, this.onRebuildWeaponPos, this);\r\n    }\r\n\r\n    protected onDisable(): void {\r\n        game.off(EventConstant.ADD_REMOVE_WEAPON_LIST, this.onAddRemoveWeaponList, this);\r\n        game.off(EventConstant.ADD_PRE_WEAPON_LIST, this.onAddPreWeaponList, this);\r\n        game.off(EventConstant.WEAPON_PlACE, this.onWeaponPlace, this);\r\n        game.off(EventConstant.WEAPON_REMOVE_REFRESH, this.initRemoveWeaponList, this);\r\n        game.off(EventConstant.INIT_BUILD_WEAPON_POS, this.onRebuildWeaponPos, this);\r\n\r\n    }\r\n\r\n    public clear() {\r\n        WeaponData.instance.clear();\r\n    }\r\n}\r\n\r\n\r\n"]}